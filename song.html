<!doctype html>
<html lang="ar" dir="rtl" data-theme="neon" data-mode="night" data-contrast="normal">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#05070F">
  <title>تشغيل الأغنية | F90 Music</title>

  <link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="styles.css?v=6" />
</head>
<body>
  <div class="bgFX"></div>

  <!-- Topbar -->
  <header class="topbar">
    <div class="wrap topbarInner">
      <div class="brand" id="goHome" role="button" tabindex="0" title="العودة للرئيسية">
        <div class="logoWrap" aria-hidden="true">
          <div class="logo">F90</div>
          <div class="headphones"></div>
        </div>
        <div class="brandTxt">
          <div class="brandTitle">اف تسعين للإنتاج الفني</div>
          <div class="brandSub">F90 Music — Official</div>
        </div>
      </div>

      <div class="topActions">
        <button class="btn pill" id="modeBtn" type="button" title="ليلي/نهاري">نهاري</button>
        <button class="btn pill" id="contrastBtn" type="button" title="تباين عالي">تباين</button>
        <button class="btn pill" id="themeBtn" type="button" title="تغيير اللون">ألوان</button>
        <button class="btn pill" id="motionBtn" type="button" title="تشغيل/إيقاف الحركة">حركة</button>
        <a class="btn primary" data-link="youtube" target="_blank" rel="noopener">قناة يوتيوب</a>
      </div>
    </div>
  </header>

  <!-- Theme Panel -->
  <div class="modalOverlay" id="themeOverlay"></div>
  <section class="modal" id="themeModal" aria-label="الثيمات">
    <div class="modalHead">
      <div class="pill">الثيمات (7)</div>
      <button class="btn pill" id="closeTheme" type="button">✕</button>
    </div>
    <div class="themeGrid" id="themeGrid"></div>
    <div class="small modalHint">يتم حفظ اختيارك تلقائياً.</div>
  </section>

  <main class="songPage">
    <div class="wrap">

      <!-- زر رجوع ثابت داخل صفحة الأغنية -->
      <button class="backBtn showAlways" id="backBtnSong" type="button" title="رجوع">⟵ رجوع</button>

      <section class="songCard">
        <div class="songHead">
          <div>
            <div class="pill" id="songPill">F90 • Song</div>
            <h1 class="songTitle" id="songTitle">—</h1>
            <div class="small" id="songMeta">—</div>
          </div>

          <div class="songBtns">
            <button class="btn pill" id="favBtn" type="button">⭐ مفضلة</button>
            <button class="btn pill" id="copyBtn" type="button">نسخ رابط</button>
            <a class="btn primary pill" id="openYT" target="_blank" rel="noopener">فتح في يوتيوب</a>
          </div>
        </div>

        <div class="playerBox">
          <div class="ytBox">
            <!-- نستخدم iframe مباشر عشان يكون ثابت وسهل -->
            <iframe
              id="ytPlayer"
              src=""
              title="YouTube player"
              frameborder="0"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
              allowfullscreen>
            </iframe>
          </div>
        </div>

        <!-- Rating -->
        <section class="rateCard">
          <div class="rateHead">
            <div class="rateTitle">تقييم الأغنية</div>
            <div class="small" id="rateInfo">قيّم من 1 إلى 5</div>
          </div>
          <div class="stars" id="stars"></div>
        </section>

        <!-- Comments -->
        <section class="commentsCard">
          <div class="commentsHead">
            <div class="commentsTitle">التعليقات داخل الموقع</div>
            <div class="small" id="cmInfo">تظهر فقط على جهازك</div>
          </div>

          <div class="cmForm">
            <input class="input" id="cmName" placeholder="اسمك (اختياري)" maxlength="40" />
            <textarea class="textarea" id="cmText" placeholder="اكتب تعليقك..." maxlength="500"></textarea>
            <div class="cmActions">
              <button class="btn primary" id="cmAdd" type="button">نشر التعليق</button>
              <button class="btn" id="cmClear" type="button">مسح الكل</button>
            </div>
          </div>

          <div class="cmList" id="cmList"></div>
        </section>

        <!-- Suggestions -->
        <section class="suggestCard">
          <div class="suggestHead">
            <div class="suggestTitle">اقتراحات</div>
            <div class="small">من نفس القوائم</div>
          </div>
          <div class="suggestGrid" id="suggestGrid"></div>
        </section>

        <div class="songNote">
          <div class="small" id="songStatus"></div>
        </div>
      </section>

      <footer class="foot">
        <div class="small">حقوق الطبع والنشر محفوظة © <span id="yearS"></span> F90</div>
      </footer>

    </div>
  </main>

  <script src="app.js?v=6"></script>

  <!-- سكربت صغير خاص بصفحة song.html (بدون الاعتماد على bootSongPage) -->
  <script>
    (function(){
      const $ = (id)=>document.getElementById(id);

      const STORE_KEY    = "f90_player_state_v4";
      const THEME_KEY    = "f90_theme_v1";
      const MOTION_KEY   = "f90_motion_v1";
      const MODE_KEY     = "f90_mode_v1";
      const CONTRAST_KEY = "f90_contrast_v1";
      const FAV_KEY      = "f90_favs_v1";

      const ratingKey = (videoId)=> `f90_rate_${videoId}`;
      const commentsKey = (videoId)=> `f90_cm_${videoId}`;

      const fmtDate = (iso)=> new Date(iso).toLocaleDateString("ar", {year:"numeric", month:"short", day:"numeric"});
      const safeText = (el, v)=>{ if(el) el.textContent = v; };

      function loadJson(k, fallback){
        try{
          const raw = localStorage.getItem(k);
          return raw ? JSON.parse(raw) : fallback;
        }catch{ return fallback; }
      }
      function saveJson(k, v){
        try{ localStorage.setItem(k, JSON.stringify(v)); }catch{}
      }

      function getTheme(){ return localStorage.getItem(THEME_KEY) || "neon"; }
      function setTheme(t){
        document.documentElement.setAttribute("data-theme", t || "neon");
        try{ localStorage.setItem(THEME_KEY, t || "neon"); }catch{}
      }
      function getMotion(){ return localStorage.getItem(MOTION_KEY) || "on"; }
      function setMotion(v){
        const val = (v==="off") ? "off" : "on";
        document.documentElement.setAttribute("data-motion", val);
        try{ localStorage.setItem(MOTION_KEY, val); }catch{}
      }
      function getMode(){ return localStorage.getItem(MODE_KEY) || "night"; }
      function setMode(v){
        const val = (v==="day") ? "day" : "night";
        document.documentElement.setAttribute("data-mode", val);
        try{ localStorage.setItem(MODE_KEY, val); }catch{}
      }
      function getContrast(){ return localStorage.getItem(CONTRAST_KEY) || "normal"; }
      function setContrast(v){
        const val = (v==="high") ? "high" : "normal";
        document.documentElement.setAttribute("data-contrast", val);
        try{ localStorage.setItem(CONTRAST_KEY, val); }catch{}
      }

      function loadFavs(){
        return loadJson(FAV_KEY, []);
      }
      function saveFavs(arr){
        saveJson(FAV_KEY, Array.from(new Set(arr)).slice(0,500));
      }
      function isFav(id){ return loadFavs().includes(id); }
      function toggleFav(id){
        const arr = loadFavs();
        const i = arr.indexOf(id);
        if(i>=0) arr.splice(i,1); else arr.unshift(id);
        saveFavs(arr);
        return arr.includes(id);
      }

      function getRating(id){
        try{ return Number(localStorage.getItem(ratingKey(id)) || 0); }catch{ return 0; }
      }
      function setRating(id, v){
        const n = Math.max(1, Math.min(5, Number(v||0)));
        try{ localStorage.setItem(ratingKey(id), String(n)); }catch{}
      }

      function loadComments(id){
        return loadJson(commentsKey(id), []);
      }
      function saveComments(id, arr){
        saveJson(commentsKey(id), arr.slice(0,200));
      }

      function buildStars(videoId){
        const stars = $("stars");
        if(!stars) return;
        const current = getRating(videoId);

        stars.innerHTML = "";
        for(let i=1;i<=5;i++){
          const b = document.createElement("button");
          b.className = "starBtn" + (i===current ? " active" : "");
          b.type = "button";
          b.textContent = "★";
          b.title = String(i);
          b.addEventListener("click", ()=>{
            setRating(videoId, i);
            buildStars(videoId);
            safeText($("rateInfo"), `تم حفظ التقييم: ${i}/5`);
            setTimeout(()=>safeText($("rateInfo"), "قيّم من 1 إلى 5"), 1200);
          });
          stars.appendChild(b);
        }
      }

      function renderComments(videoId){
        const list = $("cmList");
        if(!list) return;
        const items = loadComments(videoId);

        if(!items.length){
          list.innerHTML = `<div class="small">لا يوجد تعليقات بعد.</div>`;
          return;
        }

        list.innerHTML = items.map((c, idx)=>`
          <div class="cmItem">
            <div class="cmTop">
              <div class="cmName">${(c.name||"زائر").replace(/</g,"&lt;")}</div>
              <div class="cmTime">${(c.time||"").replace(/</g,"&lt;")}</div>
            </div>
            <div class="cmText">${(c.text||"").replace(/</g,"&lt;")}</div>
            <div style="margin-top:10px; display:flex; justify-content:flex-start;">
              <button class="btn pill cmDel" data-del="${idx}" type="button">حذف</button>
            </div>
          </div>
        `).join("");

        list.querySelectorAll("[data-del]").forEach(btn=>{
          btn.addEventListener("click", ()=>{
            const i = Number(btn.getAttribute("data-del"));
            const arr = loadComments(videoId);
            arr.splice(i,1);
            saveComments(videoId, arr);
            renderComments(videoId);
          });
        });
      }

      function parseVideoId(){
        const u = new URL(location.href);
        const v = u.searchParams.get("v");
        if(v) return v;
        // fallback: song.html?v=ID style already used
        return "";
      }

      function setIframe(videoId){
        const autoplay = (new URL(location.href)).searchParams.get("autoplay") === "1" ? 1 : 0;
        const src = `https://www.youtube.com/embed/${encodeURIComponent(videoId)}?autoplay=${autoplay}&rel=0&modestbranding=1`;
        const iframe = $("ytPlayer");
        if(iframe) iframe.src = src;
      }

      function readSavedMeta(videoId){
        // Try to find track details from saved state list (if exists)
        const saved = loadJson(STORE_KEY, null);
        // No actual titles saved here; so we show videoId as fallback
        safeText($("songTitle"), "تشغيل الأغنية");
        safeText($("songMeta"), `ID: ${videoId}`);
      }

      function applyLinks(){
        // app.js already injects links using data-link,
        // but to be safe on song.html:
        const map = {
          youtube: "https://youtube.com/@f90-music?si=VnsVH56lT7UV8N4n"
        };
        Object.keys(map).forEach(k=>{
          document.querySelectorAll(`[data-link="${k}"]`).forEach(a=>a.setAttribute("href", map[k]));
        });
      }

      function refreshModeButtons(){
        const mode = document.documentElement.getAttribute("data-mode") || "night";
        const contrast = document.documentElement.getAttribute("data-contrast") || "normal";
        const modeBtn = $("modeBtn");
        const contrastBtn = $("contrastBtn");
        if(modeBtn) modeBtn.textContent = (mode === "day") ? "ليلي" : "نهاري";
        if(contrastBtn) contrastBtn.textContent = (contrast === "high") ? "عادي" : "تباين";
      }

      function bindTopToggles(){
        $("modeBtn")?.addEventListener("click", ()=>{
          setMode(getMode()==="day" ? "night" : "day");
          refreshModeButtons();
        });
        $("contrastBtn")?.addEventListener("click", ()=>{
          setContrast(getContrast()==="high" ? "normal" : "high");
          refreshModeButtons();
        });
        $("motionBtn")?.addEventListener("click", ()=>{
          setMotion(getMotion()==="on" ? "off" : "on");
        });

        // Theme modal open/close (same ids as index)
        $("themeBtn")?.addEventListener("click", ()=>{
          $("themeOverlay")?.classList.add("open");
          $("themeModal")?.classList.add("open");
        });
        $("closeTheme")?.addEventListener("click", ()=>{
          $("themeOverlay")?.classList.remove("open");
          $("themeModal")?.classList.remove("open");
        });
        $("themeOverlay")?.addEventListener("pointerdown", ()=>{
          $("themeOverlay")?.classList.remove("open");
          $("themeModal")?.classList.remove("open");
        }, true);
      }

      function buildThemeGrid(){
        const THEMES = [
          { id:"neon",   name:"Neon"   },
          { id:"cyan",   name:"Cyan"   },
          { id:"purple", name:"Purple" },
          { id:"gold",   name:"Gold"   },
          { id:"red",    name:"Red"    },
          { id:"green",  name:"Green"  },
          { id:"mono",   name:"Mono"   },
        ];
        const grid = $("themeGrid");
        if(!grid) return;
        grid.innerHTML = THEMES.map(t=>`
          <button class="themeSwatch" type="button" data-theme="${t.id}">
            <div class="swTop">
              <div class="swName">${t.name}</div>
              <div class="swDot"></div>
            </div>
            <div class="swBar"></div>
          </button>
        `).join("");

        grid.querySelectorAll(".themeSwatch").forEach(btn=>{
          btn.addEventListener("click", ()=>{
            const id = btn.getAttribute("data-theme") || "neon";
            setTheme(id);
            $("themeOverlay")?.classList.remove("open");
            $("themeModal")?.classList.remove("open");
          });
        });
      }

      function bindActions(videoId){
        $("backBtnSong")?.addEventListener("click", ()=> history.back());
        $("goHome")?.addEventListener("click", ()=> location.href = "index.html#/home");

        $("copyBtn")?.addEventListener("click", async ()=>{
          try{
            await navigator.clipboard.writeText(location.href);
            safeText($("songStatus"), "تم نسخ الرابط.");
            setTimeout(()=>safeText($("songStatus"), ""), 1200);
          }catch{
            safeText($("songStatus"), "تعذر نسخ الرابط.");
            setTimeout(()=>safeText($("songStatus"), ""), 1200);
          }
        });

        const openYT = $("openYT");
        if(openYT) openYT.href = `https://www.youtube.com/watch?v=${encodeURIComponent(videoId)}`;

        const favBtn = $("favBtn");
        const repaintFav = ()=>{
          const on = isFav(videoId);
          if(favBtn) favBtn.textContent = on ? "⭐ ضمن المفضلة" : "⭐ مفضلة";
          favBtn?.classList.toggle("on", on);
        };
        repaintFav();
        favBtn?.addEventListener("click", ()=>{
          toggleFav(videoId);
          repaintFav();
        });

        // comments add/clear
        $("cmAdd")?.addEventListener("click", ()=>{
          const name = ($("cmName")?.value || "").trim().slice(0,40);
          const text = ($("cmText")?.value || "").trim().slice(0,500);
          if(!text){
            safeText($("cmInfo"), "اكتب تعليق أولاً.");
            setTimeout(()=>safeText($("cmInfo"), "تظهر فقط على جهازك"), 1200);
            return;
          }
          const arr = loadComments(videoId);
          arr.unshift({
            name: name || "زائر",
            text,
            time: new Date().toLocaleString("ar")
          });
          saveComments(videoId, arr);
          if($("cmText")) $("cmText").value = "";
          renderComments(videoId);
        });

        $("cmClear")?.addEventListener("click", ()=>{
          saveComments(videoId, []);
          renderComments(videoId);
        });
      }

      window.addEventListener("load", ()=>{
        // basic year
        const y = new Date().getFullYear();
        if($("yearS")) $("yearS").textContent = y;

        // apply saved theme/mode/motion/contrast
        setTheme(getTheme());
        setMotion(getMotion());
        setMode(getMode());
        setContrast(getContrast());
        refreshModeButtons();

        applyLinks();
        bindTopToggles();
        buildThemeGrid();

        const videoId = parseVideoId();
        if(!videoId){
          safeText($("songTitle"), "خطأ");
          safeText($("songMeta"), "لم يتم العثور على ID للفيديو.");
          safeText($("songStatus"), "ارجع للرئيسية وافتح الأغنية من هناك.");
          return;
        }

        setIframe(videoId);
        readSavedMeta(videoId);

        buildStars(videoId);
        renderComments(videoId);
        bindActions(videoId);
      });
    })();
  </script>
</body>
</html>
